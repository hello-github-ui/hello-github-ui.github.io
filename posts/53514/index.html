<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>分布式消息队列RocketMQ-学习文档-第二章 | Lorem MoonのStory</title><meta name="keywords" content="RocketMQ"><meta name="author" content="Lorem Moon"><meta name="copyright" content="Lorem Moon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="分布式消息队列RocketMQ学习文档 本文资料来源：尚硅谷 | 本文发表时RocketMQ的版本：v4.9.2 | 本资料是第二章内容，本文档总共有四章。     文章目录：   分布式消息队列RocketMQ-学习文档-第一章 分布式消息队列RocketMQ-学习文档-第二章 分布式消息队列RocketMQ-学习文档-第三章 分布式消息队列RocketMQ-学习文档-第四章     第2章 R">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式消息队列RocketMQ-学习文档-第二章">
<meta property="og:url" content="https://hello-github-ui.github.io/posts/53514/index.html">
<meta property="og:site_name" content="Lorem MoonのStory">
<meta property="og:description" content="分布式消息队列RocketMQ学习文档 本文资料来源：尚硅谷 | 本文发表时RocketMQ的版本：v4.9.2 | 本资料是第二章内容，本文档总共有四章。     文章目录：   分布式消息队列RocketMQ-学习文档-第一章 分布式消息队列RocketMQ-学习文档-第二章 分布式消息队列RocketMQ-学习文档-第三章 分布式消息队列RocketMQ-学习文档-第四章     第2章 R">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/617bf6342ab3f51d9143ec11.jpg">
<meta property="article:published_time" content="2021-10-29T13:56:18.000Z">
<meta property="article:modified_time" content="2022-10-22T06:47:40.080Z">
<meta property="article:author" content="Lorem Moon">
<meta property="article:tag" content="RocketMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/617bf6342ab3f51d9143ec11.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://hello-github-ui.github.io/posts/53514/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"D5QZVMNT9K","apiKey":"92de0b03da46fa778c95817524081160","indexName":"hexo-blog","hits":{"per_page":100},"languages":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}.","hits_stats":"${hits} results found in ${time} ms"}},
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '分布式消息队列RocketMQ-学习文档-第二章',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2022-10-22 14:47:40'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imgdb.cn/item/6159d89b2ab3f51d91b0e8d0.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">60</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">46</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/musics/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic.imgdb.cn/item/617bf6342ab3f51d9143ec11.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lorem MoonのStory</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/musics/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">分布式消息队列RocketMQ-学习文档-第二章<a class="post-edit-link" href="https://github.com/hello-github-ui/hexo-blog-source/tree/master/source/_posts/分布式消息队列RocketMQ-学习文档-第二章.md" title="Edited on" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-29T13:56:18.000Z" title="Created 2021-10-29 21:56:18">2021-10-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-10-22T06:47:40.080Z" title="Updated 2022-10-22 14:47:40">2022-10-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/code/">code</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">10.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>35min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="分布式消息队列RocketMQ-学习文档-第二章"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="分布式消息队列RocketMQ学习文档"><a href="#分布式消息队列RocketMQ学习文档" class="headerlink" title="分布式消息队列RocketMQ学习文档"></a>分布式消息队列RocketMQ学习文档</h1><blockquote>
<p>本文资料来源：尚硅谷 | 本文发表时RocketMQ的版本：<code>v4.9.2</code> | 本资料是第二章内容，本文档总共有四章。</p>
</blockquote>
<hr/>

<blockquote>
<p>文章目录：</p>
</blockquote>
<ul>
<li><a target="_blank" href="https://hello-blogger-ui.blogspot.com/2021/10/rocketmq.html">分布式消息队列RocketMQ-学习文档-第一章</a></li>
<li><a target="_blank" href="https://hello-blogger-ui.blogspot.com/2021/10/rocketmq_29.html">分布式消息队列RocketMQ-学习文档-第二章</a></li>
<li><a target="_blank" href="https://hello-blogger-ui.blogspot.com/2021/10/rocketmq_62.html">分布式消息队列RocketMQ-学习文档-第三章</a></li>
<li><a target="_blank" href="https://hello-blogger-ui.blogspot.com/2021/10/rocketmq_32.html">分布式消息队列RocketMQ-学习文档-第四章</a></li>
</ul>



<h2 id="第2章-RocketMQ的安装与启动"><a href="#第2章-RocketMQ的安装与启动" class="headerlink" title="第2章 RocketMQ的安装与启动"></a>第2章 RocketMQ的安装与启动</h2><h3 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h3><h4 id="1、消息（Message）"><a href="#1、消息（Message）" class="headerlink" title="1、消息（Message）"></a>1、消息（Message）</h4><p>消息是指，消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。</p>
<h4 id="2、主题（Topic）"><a href="#2、主题（Topic）" class="headerlink" title="2、主题（Topic）"></a>2、主题（Topic）</h4><p><img src="https://pic.imgdb.cn/item/617ac1bc2ab3f51d9143e847.jpg">{width=”5.575in” height=”5.533333333333333in”}</p>
<p>Topic表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。 topic:message 1:n message:topic 1:1</p>
<p>一个生产者可以同时发送多种Topic的消息；而一个消费者只对某种特定的Topic感兴趣，即只可以订阅和消费一种Topic的消息。 producer:topic 1:n consumer:topic 1:1</p>
<h4 id="3、标签（Tag）"><a href="#3、标签（Tag）" class="headerlink" title="3、标签（Tag）"></a>3、标签（Tag）</h4><p>为消息设置的标签，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p>
<p>Topic是消息的一级分类，Tag是消息的二级分类。</p>
<p>Topic：货物</p>
<p>tag=上海</p>
<p>tag=江苏</p>
<p>tag=浙江</p>
<p>——- 消费者 —–</p>
<p>topic=货物 tag = 上海</p>
<p>topic=货物 tag = 上海|浙江</p>
<p>topic=货物 tag = *</p>
<h4 id="4、队列（Queue）"><a href="#4、队列（Queue）" class="headerlink" title="4、队列（Queue）"></a>4、队列（Queue）</h4><p>存储消息的物理实体。一个Topic中可以包含多个Queue，每个Queue中存放的就是该Topic的消息。一个Topic的Queue也被称为一个Topic中消息的分区（Partition）。</p>
<p>一个Topic的Queue中的消息只能被一个消费者组中的一个消费者消费。一个Queue中的消息不允许同一个消费者组中的多个消费者同时消费。</p>
<p><img src="https://pic.imgdb.cn/item/617ac0d12ab3f51d9142b47c.jpg">{width=”5.66875in” height=”5.439583333333333in”}</p>
<p>在学习参考其它相关资料时，还会看到一个概念：分片（Sharding）。分片不同于分区。在RocketMQ中，分片指的是存放相应Topic的Broker。每个分片中会创建出相应数量的分区，即Queue，每个Queue的大小都是相同的。</p>
<p><img src="https://pic.imgdb.cn/item/617ac05f2ab3f51d91421eaa.jpg">{width=”6.106944444444444in” height=”4.23125in”}</p>
<h4 id="5、消息标识（MessageId-Key）"><a href="#5、消息标识（MessageId-Key）" class="headerlink" title="5、消息标识（MessageId/Key）"></a>5、消息标识（MessageId/Key）</h4><p>RocketMQ中每个消息拥有唯一的MessageId，且可以携带具有业务标识的Key，以方便对消息的查询。不过需要注意的是，MessageId有两个：在生产者send()消息时会自动生成一个MessageId（msgId)，当消息到达Broker后，Broker也会自动生成一个MessageId(offsetMsgId)。msgId、offsetMsgId与key都称为消息标识。</p>
<ul>
<li><p>msgId：由producer端生成，其生成规则为：<br><font color="#00CED1">producerIp + 进程pid + MessageClientIDSetter类的ClassLoader的hashCode + 当前时间 + AutomicInteger自增计数器</font></p>
</li>
<li><p>offsetMsgId：由broker端生成，其生成规则为：<font color="#00CED1">brokerIp + 物理分区的offset（Queue中的偏移量）</font></p>
</li>
<li><p>key：由用户指定的业务相关的唯一标识</p>
</li>
</ul>
<blockquote>
</blockquote>
<h3 id="二、系统架构"><a href="#二、系统架构" class="headerlink" title="二、系统架构"></a>二、系统架构</h3><p><img src="https://pic.imgdb.cn/item/617abd0a2ab3f51d913e04b7.jpg">{width=”6.106944444444444in” height=”2.532638888888889in”}</p>
<p>RocketMQ架构上主要分为四部分构成：</p>
<h4 id="1、Producer"><a href="#1、Producer" class="headerlink" title="1、Producer"></a>1、Producer</h4><p>消息生产者，负责生产消息。Producer通过MQ的负载均衡模块选择相应的Broker集群队列进行消息投递，投递的过程支持快速失败并且低延迟。</p>
<blockquote>
<p>例如，业务系统产生的日志写入到 的过程，就是消息生产的过程</p>
<p>再如，电商平台中用户提交的秒杀请求写入到 的过程，就是消息生产的过程</p>
</blockquote>
<p>RocketMQ中的消息生产者都是以生产者组（Producer Group）的形式出现的。生产者组是同一类生产者的集合，这类Producer发送相同Topic类型的消息。一个生产者组可以同时发送多个主题的消息。</p>
<h4 id="2、Consumer"><a href="#2、Consumer" class="headerlink" title="2、Consumer"></a>2、Consumer</h4><p>消息消费者，负责消费消息。一个消息消费者会从Broker服务器中获取到消息，并对消息进行相关业务处理。</p>
<blockquote>
<p>例如，QoS 系统从 MQ 中读取日志，并对日志进行解析处理的过程就是消息消费的过程。</p>
<p>再如，电商平台的业务系统从 MQ 中读取到秒杀请求，并对请求进行处理的过程就是消息消费的过程。</p>
</blockquote>
<p>RocketMQ中的消息消费者都是以消费者组（Consumer Group）的形式出现的。消费者组是同一类消费者的集合，这类Consumer消费的是同一个Topic类型的消息。消费者组使得在消息消费方面，实现<font color=" #00BFFF">负载均衡</font>（将一个Topic中的不同的Queue平均分配给同一个Consumer Group的不同的Consumer，注意，并不是将消息负载均衡）和<font color=" #00BFFF">容错</font>（一个Consmer挂了，该Consumer Group中的其它Consumer可以接着消费原Consumer消费的Queue）的目标变得非常容易。</p>
<p><img src="https://pic.imgdb.cn/item/617ab2a42ab3f51d9130e7c9.jpg">{width=”6.106944444444444in” height=”2.4381944444444446in”}</p>
<blockquote>
<p>消费者组中Consumer的数量应该小于等于订阅Topic的Queue数量。如果超出Queue数量，则多出的Consumer将不能消费消息。</p>
</blockquote>
<p><img src="https://pic.imgdb.cn/item/617ab33b2ab3f51d913188b4.jpg">{width=”6.106944444444444in” height=”2.9180555555555556in”}</p>
<p>不过，一个Topic类型的消息可以被多个消费者组同时消费。</p>
<blockquote>
<p>注意，</p>
<ol>
<li>消费者组只能消费一个Topic的消息，不能同时消费多个Topic消息</li>
<li>一个消费者组中的消费者必须订阅相同的Topic</li>
</ol>
</blockquote>
<h4 id="3、Name-Server"><a href="#3、Name-Server" class="headerlink" title="3、Name Server"></a>3、Name Server</h4><h5 id="①、功能介绍"><a href="#①、功能介绍" class="headerlink" title="①、功能介绍"></a>①、功能介绍</h5><p>NameServer是一个Broker与Topic路由的注册中心，支持Broker的动态注册与发现。</p>
<p> RocketMQ的思想来自于Kafka，而Kafka是依赖了Zookeeper的。所以，在RocketMQ的早期版本，即在 MetaQ v1.0与v2.0版本中，也是依赖于Zookeeper的。从MetaQ v3.0，即RocketMQ开始去掉了Zookeeper依赖，使用了自己的NameServer。</p>
<p>主要包括两个功能：</p>
<ul>
<li><p><font color="#F00">Broker管理</font>：接受Broker集群的注册信息并且保存下来作为路由信息的基本数据；提供心跳检测机制，检查Broker是否还存活。</p>
</li>
<li><p><font color="#F00">路由信息管理</font>：每个NameServer中都保存着Broker集群的整个路由信息和用于客户端查询的队列信息。Producer和Conumser通过NameServer可以获取整个Broker集群的路由信息，从而进行消息的投递和消费。</p>
</li>
</ul>
<h5 id="②、路由注册"><a href="#②、路由注册" class="headerlink" title="②、路由注册"></a>②、路由注册</h5><p>NameServer通常也是以集群的方式部署，不过，NameServer是无状态的，即NameServer集群中的各个节点间是无差异的，各节点间相互不进行信息通讯。那各节点中的数据是如何进行数据同步的呢？在Broker节点启动时，轮询NameServer列表，与每个NameServer节点建立长连接，发起注册请求。在NameServer内部维护着一个Broker列表，用来动态存储Broker的信息。</p>
<blockquote>
<p>注意，这是与其它像 <code>zk</code>、<code>Eureka</code>、<code>Nacos</code>等注册中心不同的地方。<br>这种 <strong>NameServer</strong> 的无状态方式，有什么优缺点：</p>
</blockquote>
<blockquote>
<p>优点：NameServer 集群搭建简单，扩容简单。</p>
</blockquote>
<blockquote>
<p>缺点：对于 Broker，必须明确指出所有 NameServer 地址。否则未指出的将&gt; 不会去注册。也正因如此， NameServer并不能随便扩容。因为，若Broker不&gt; 重新配置，新增的NameServer对于Broker来说是不可见的，其不会向这个NameServer进行注册。</p>
</blockquote>
<p>Broker节点为了证明自己是活着的，为了维护与NameServer间的长连接，会将最新的信息以<font color="#00CED1">心跳包</font>的方式上报给NameServer，每30秒发送一次心跳。心跳包中包含 BrokerId、Broker地址(IP+Port)、Broker名称、Broker所属集群名称等等。NameServer在接收到心跳包后，会更新心跳时间戳，记录这个Broker的最新存活时间。</p>
<h5 id="③、路由剔除"><a href="#③、路由剔除" class="headerlink" title="③、路由剔除"></a>③、路由剔除</h5><p>由于Broker关机、宕机或网络抖动等原因，NameServer没有收到Broker的心跳，NameServer可能会将其从Broker列表中剔除。</p>
<p>NameServer中有一个定时任务，每隔10秒就会扫描一次Broker表，查看每一个Broker的最新心跳时间戳距离当前时间是否超过120秒，如果超过，则会判定Broker失效，然后将其从Broker列表中剔除。</p>
<blockquote>
<p>扩展：对于RocketMQ日常运维工作，例如Broker升级，需要停掉Broker的工作，OP需要怎么做？<br>OP需要将Broker的读写权限禁掉。一旦Client（Consumer或Producer）向broker发送请求，都会收到broker的<font color="#00CED1">NO_PERMISSION</font>响应，然后client会进行对其它Broker的重试。<br>当OP观察到这个Broker没有流量后，再关闭它，实现Broker从NameServer的移除。<br>OP：运维工程师<br>SRE：Site Reliability Engineer，现场可靠性工程师。</p>
</blockquote>
<h5 id="④、路由发现"><a href="#④、路由发现" class="headerlink" title="④、路由发现"></a>④、路由发现</h5><p>RocketMQ的路由发现采用的是Pull模型。当Topic路由信息出现变化时，NameServer不会主动推送给客户端，而是客户端定时拉取主题最新的路由。默认客户端每30秒会拉取一次最新的路由。</p>
<blockquote>
<p>扩展：</p>
<ol>
<li><font color="#FF6A6A">Push模型</font>：推送模型。其实时性较好，是一个 “发布-订阅” 模型，需要维护一个长连接。而长连接的维护是需要资源成本的。该模型适合于的场景：</li>
</ol>
<ul>
<li>实时性要求较高</li>
<li>Client数量不多， Server数据变化较频繁</li>
</ul>
<ol start="2">
<li><font color="#FF6A6A">Pull模型</font>：拉取模型。存在的问题是，实时性较差。</li>
<li><font color="#FF6A6A">Long Polling模型</font>：长轮询模型。其是对 <code>Push</code> 与 <code>Pull</code> 模型的整合，充分利用了这两种模型的优势，屏蔽了它们的劣势。</li>
</ol>
</blockquote>
<h5 id="⑤、客户端NameServer选择策略"><a href="#⑤、客户端NameServer选择策略" class="headerlink" title="⑤、客户端NameServer选择策略"></a>⑤、客户端NameServer选择策略</h5><blockquote>
<p>这里的客户端指的是 Producer 与 Consumer</p>
</blockquote>
<p>客户端在配置时必须要写上NameServer集群的地址，那么客户端到底连接的是哪个NameServer节点呢？客户端首先会生产一个随机数，然后再与NameServer节点数量取模，此时得到的就是所要连接的节点索引，然后就会进行连接。如果连接失败，则会采用round-robin策略，逐个尝试着去连接其它节点。</p>
<p>首先采用的是<font color="#FF00FF">随机策略</font>进行的选择，失败后采用的是<font color="#FF00FF">轮询策略</font>。</p>
<blockquote>
<p>扩展：Zookeeper Client是如何选择 Zookeeper Server的？<br>简单来说就是，经过两次 shuffle，然后选择第一台 Zookeeper Server。<br>详细说就是，将配置文件中的 zk server地址进行第一次 shuffle，然后随机选择一个。这个选择出的一般都是一个hostname。然后获取到该 hostname对应的所有ip，再对这些ip进行第二次shuffle，从shuffle过的结果中取第一个server地址进行连接。</p>
</blockquote>
<h4 id="4-Broker"><a href="#4-Broker" class="headerlink" title="4 Broker"></a>4 Broker</h4><h5 id="①、功能介绍-1"><a href="#①、功能介绍-1" class="headerlink" title="①、功能介绍"></a>①、功能介绍</h5><p>Broker充当着消息中转角色，负责存储消息、转发消息。Broker在RocketMQ系统中负责接收并存储从生产者发送来的消息，同时为消费者的拉取请求作准备。Broker同时也存储着消息相关的元数据，包括消费者组消费进度偏移offset、主题、队列等。</p>
<blockquote>
<p><em><strong>Kafka 0.8</strong></em>版本之后， <em><strong>offset</strong></em>是存放在 <em><strong>Broker</strong></em> 中的，之前版本是存放在 <em><strong>Zookeeper</strong></em> 中的。</p>
</blockquote>
<h5 id="②、模块构成"><a href="#②、模块构成" class="headerlink" title="②、模块构成"></a>②、模块构成</h5><p>下图为Broker Server的功能模块示意图。</p>
<p><img src="https://pic.imgdb.cn/item/617abc0d2ab3f51d913d08e1.jpg">{width=”6.106944444444444in” height=”3.563888888888889in”}</p>
<p><font color="#FF0000">Remoting Module</font>：整个Broker的实体，负责处理来自clients端的请求。而这个Broker实体则由以下模块构成。</p>
<p><font color="#FF0000">Client Manager</font>：客户端管理器。负责接收、解析客户端(Producer/Consumer)请求，管理客户端。例如，维护Consumer的Topic订阅信息</p>
<p><font color="#FF0000">Store Service</font>：存储服务。提供方便简单的API接口，处理<font color="#1E90FF">消息存储到物理硬盘</font>和<font color="#1E90FF">消息查询</font>功能。</p>
<p><font color="#FF0000">HA Service</font>：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</p>
<p><font color="#FF0000">Index Service</font>：索引服务。根据特定的Message key，对投递到Broker的消息进行索引服务，同时也提供根据Message Key对消息进行快速查询的功能。</p>
<h5 id="③、集群部署"><a href="#③、集群部署" class="headerlink" title="③、集群部署"></a>③、集群部署</h5><p><img src="https://pic.imgdb.cn/item/617abd0a2ab3f51d913e04b7.jpg">{width=”6.106944444444444in” height=”2.532638888888889in”}</p>
<p>为了增强Broker性能与吞吐量，Broker一般都是以集群形式出现的。各集群节点中可能存放着相同Topic的不同Queue。不过，这里有个问题，如果某Broker节点宕机，如何保证数据不丢失呢？其解决方案是，将每个Broker集群节点进行横向扩展，即将Broker节点再建为一个HA集群，解决单点问题。</p>
<p>Broker节点集群是一个主从集群，即集群中具有Master与Slave两种角色。Master负责处理读写操作请求，Slave负责对Master中的数据进行备份。当Master挂掉了，Slave则会自动切换为Master去工作。所以这个Broker集群是主备集群。一个Master可以包含多个Slave，但一个Slave只能隶属于一个Master。Master与Slave 的对应关系是通过指定相同的BrokerName、不同的BrokerId 来确定的。BrokerId为0表示Master，非0表示Slave。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。</p>
<h4 id="5-工作流程"><a href="#5-工作流程" class="headerlink" title="5 工作流程"></a>5 工作流程</h4><h5 id="①、具体流程"><a href="#①、具体流程" class="headerlink" title="①、具体流程"></a>①、具体流程</h5><p>1）启动NameServer，NameServer启动后开始监听端口，等待Broker、Producer、Consumer连接。</p>
<p>2）启动Broker时，Broker会与所有的NameServer建立并保持长连接，然后每30秒向NameServer定时发送心跳包。</p>
<p>3）发送消息前，可以先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，当然，在创建Topic时也会将Topic与Broker的关系写入到NameServer中。不过，这步是可选的，也可以在发送消息时自动创建Topic。</p>
<p>4）Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取路由信息，即当前发送的Topic消息的Queue与Broker的地址（IP+Port）的映射关系。然后根据算法策略从队选择一个Queue，与队列所在的Broker建立长连接从而向Broker发消息。当然，在获取到路由信息后，Producer会首先将路由信息缓存到本地，再每30秒从NameServer更新一次路由信息。</p>
<p>5）Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取其所订阅Topic的路由信息，然后根据算法策略从路由信息中获取到其所要消费的Queue，然后直接跟Broker建立长连接，开始消费其中的消息。Consumer在获取到路由信息后，同样也会每30秒从NameServer更新一次路由信息。不过不同于Producer的是，Consumer还会向Broker发送心跳，以确保Broker的存活状态。</p>
<h5 id="②、Topic"><a href="#②、Topic" class="headerlink" title="②、Topic"></a>②、Topic</h5><p>手动创建Topic时，有两种模式：</p>
<ul>
<li>集群模式：该模式下创建的Topic在该集群中，所有Broker中的Queue数量是相同的。</li>
<li>Broker模式：该模式下创建的Topic在该集群中，每个Broker中的Queue数量可以不同。</li>
</ul>
<p><font color="#FFF68F">自动创建Topic时，默认采用的是Broker模式，会为每个Broker默认创建4个Queue。</font></p>
<h5 id="③、读-写队列"><a href="#③、读-写队列" class="headerlink" title="③、读/写队列"></a>③、读/写队列</h5><p>从物理上来讲，读/写队列是同一个队列。所以，不存在读/写队列数据同步问题。读/写队列是逻辑上进行区分的概念。一般情况下，读/写队列数量是相同的。</p>
<blockquote>
<p>例如，创建Topic时设置的写队列数量为8，读队列数量为4，此时系统会创建8个Queue，分别是0 1 2 3 4 5 6 7。Producer会将消息写入到这8个队列，但Consumer只会消费0 1 2 3这4个队列中的消息，4 5 6 7中的消息是不会被消费到的。</p>
</blockquote>
<blockquote>
<p>再如，创建Topic时设置的写队列数量为4，读队列数量为8，此时系统会创建8个Queue，分别是0 1 2 3 4 5 6 7。Producer会将消息写入到0 1 2 3 这4个队列，但Consumer只会消费0 1 2 3 4 5 6 7这8个队列中的消息，但是4 5 6 7中是没有消息的。此时假设Consumer Group中包含两个Consuer，Consumer1消费0 1 2 3，而Consumer2消费4 5 6 7。但实际情况是，Consumer2是没有消息可消费的。</p>
</blockquote>
<blockquote>
<p>也就是说，当读/写队列数量设置不同时，总是有问题的。那么，为什么要这样设计呢？</p>
<p>其这样设计的目的是为了，方便Topic的Queue的缩容。</p>
<p>例如，原来创建的Topic中包含16个Queue，如何能够使其Queue缩容为8个，还不会丢失消息？可以动态修改写队列数量为8，读队列数量不变。此时新的消息只能写入到前8个队列，而消费都消费的却是16个队列中的数据。当发现后8个Queue中的消息消费完毕后，就可以再将读队列数量动态设置为8。整个缩容过程，没有丢失任何消息。</p>
<p>perm用于设置对当前创建Topic的操作权限：2表示只写，4表示只读，6表示读写。</p>
</blockquote>
<h3 id="三、单机安装与启动"><a href="#三、单机安装与启动" class="headerlink" title="三、单机安装与启动"></a>三、单机安装与启动</h3><h4 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h4><h5 id="①、软硬件需求"><a href="#①、软硬件需求" class="headerlink" title="①、软硬件需求"></a>①、软硬件需求</h5><p>系统要求是64位的，JDK要求是1.8及其以上版本的。</p>
<p><img src="https://pic.imgdb.cn/item/617ac5fd2ab3f51d91498a27.jpg">{width=”6.106944444444444in” height=”3.6055555555555556in”}</p>
<h5 id="②、下载RocketMQ安装包"><a href="#②、下载RocketMQ安装包" class="headerlink" title="②、下载RocketMQ安装包"></a>②、下载RocketMQ安装包</h5><p><img src="https://pic.imgdb.cn/item/617ac6332ab3f51d9149cdee.jpg">{width=”6.106944444444444in” height=”6.096527777777778in”}</p>
<p>将下载的安装包上传到Linux。<em><strong>一般我将软件上传到<code>/opt/tools</code>下，解压缩后放到 <code>/opt/apps</code>下</strong></em></p>
<p><img src="https://pic.imgdb.cn/item/617ac65c2ab3f51d914a08f9.jpg">{width=”6.106944444444444in” height=”0.8229166666666666in”}</p>
<p>解压：<code>unzip rocketmq-all-4.8.0-bin-release.zip -D /opt/apps</code></p>
<p><img src="https://pic.imgdb.cn/item/617ac66e2ab3f51d914a213e.jpg">{width=”6.106944444444444in” height=”2.1881944444444446in”}</p>
<h4 id="2、修改初始内存"><a href="#2、修改初始内存" class="headerlink" title="2、修改初始内存"></a>2、修改初始内存</h4><h5 id="①、修改runserver-sh"><a href="#①、修改runserver-sh" class="headerlink" title="①、修改runserver.sh"></a>①、修改runserver.sh</h5><p>使用vim命令打开bin/runserver.sh文件。现将这些值修改为如下：</p>
<p><img src="https://pic.imgdb.cn/item/617ac7902ab3f51d914ba23c.jpg">{width=”6.106944444444444in” height=”1.823611111111111in”}</p>
<h5 id="②、修改runbroker-sh"><a href="#②、修改runbroker-sh" class="headerlink" title="②、修改runbroker.sh"></a>②、修改runbroker.sh</h5><p>使用vim命令打开bin/runbroker.sh文件。现将这些值修改为如下：</p>
<p><img src="https://pic.imgdb.cn/item/617ac7aa2ab3f51d914bc3a6.jpg">{width=”6.106944444444444in” height=”1.167361111111111in”}</p>
<h4 id="3、启动"><a href="#3、启动" class="headerlink" title="3、启动"></a>3、启动</h4><h5 id="①、启动NameServer"><a href="#①、启动NameServer" class="headerlink" title="①、启动NameServer"></a>①、启动NameServer</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqnamesrv &amp;</span><br><span class="line">tail -f \~/logs/rocketmqlogs/namesrv.log</span><br></pre></td></tr></table></figure>

<p><img src="https://pic.imgdb.cn/item/617ac8e92ab3f51d914d9951.jpg">{width=”6.106944444444444in” height=”2.0527777777777776in”}</p>
<h5 id="②、启动broker"><a href="#②、启动broker" class="headerlink" title="②、启动broker"></a>②、启动broker</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqbroker -n localhost:9876 &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<p><img src="https://pic.imgdb.cn/item/617aca672ab3f51d914fc144.jpg">{width=”6.106944444444444in” height=”1.792361111111111in”}</p>
<h4 id="4、发送-接收消息测试"><a href="#4、发送-接收消息测试" class="headerlink" title="4、发送/接收消息测试"></a>4、发送/接收消息测试</h4><h5 id="①、发送消息"><a href="#①、发送消息" class="headerlink" title="①、发送消息"></a>①、发送消息</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export NAMESRV_ADDR=localhost:9876</span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure>


<h5 id="②、接收消息"><a href="#②、接收消息" class="headerlink" title="②、接收消息"></a>②、接收消息</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure>


<h4 id="5、关闭Server"><a href="#5、关闭Server" class="headerlink" title="5、关闭Server"></a>5、关闭Server</h4><p>无论是关闭name server还是broker，都是使用bin/mqshutdown命令。</p>
<p><img src="https://pic.imgdb.cn/item/617acbca2ab3f51d91515d86.jpg">{width=”5.022916666666666in” height=”1.667361111111111in”}</p>
<h3 id="四、-控制台的安装与启动"><a href="#四、-控制台的安装与启动" class="headerlink" title="四、 控制台的安装与启动"></a>四、 控制台的安装与启动</h3><p>RocketMQ有一个可视化的dashboard，通过该控制台可以直观的查看到很多数据。</p>
<h4 id="1、下载"><a href="#1、下载" class="headerlink" title="1、下载"></a>1、下载</h4><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals/releases">https://github.com/apache/rocketmq-externals/releases</a></p>
<p><img src="https://pic.imgdb.cn/item/617accff2ab3f51d9152eb17.jpg">{width=”6.106944444444444in” height=”6.492361111111111in”}</p>
<h4 id="2、修改配置"><a href="#2、修改配置" class="headerlink" title="2、修改配置"></a>2、修改配置</h4><p>修改其src/main/resources中的application.properties配置文件。</p>
<ul>
<li>原来的端口号为8080，修改为一个不常用的，比如7000</li>
<li>指定RocketMQ的name server地址</li>
</ul>
<p><del>其实我不太推荐在配置文件中写死<code>rocketmq.config.namesrvAddr=192.168.80.6:9876</code>，更喜欢这里写为null，然后通过<code>jar -jar rocketmq-console-ng-1.0.0.jar --rocketmq.config.namesrvAddr=192.168.80.6:9876</code>这种方式，因为其很灵活，不需要每次修改配置文件后再重新打包</del></p>
<p><img src="https://pic.imgdb.cn/item/617acd902ab3f51d9153d65c.jpg">{width=”5.585416666666666in” height=”3.657638888888889in”}</p>
<h4 id="3、添加依赖"><a href="#3、添加依赖" class="headerlink" title="3、添加依赖"></a>3、添加依赖</h4><p>在解压目录rocketmq-console的pom.xml中添加如下JAXB依赖。</p>
<blockquote>
<p>JAXB，Java Architechture for Xml Binding，用于XML绑定的Java技术，是一个业界标准，是一项可以根据XML Schema生成Java类的技术。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- JAXB 可以根据XML Scheme 生成 Java 类的依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="4、打包"><a href="#4、打包" class="headerlink" title="4、打包"></a>4、打包</h4><p>在rocketmq-console目录下打开CMD（注意切记不要使用PowerShell），运行maven的打包命令。<br><code>mvn clean package -Dmaven.test.skip=true</code></p>
<h4 id="5、启动"><a href="#5、启动" class="headerlink" title="5、启动"></a>5、启动</h4><p><code>java -jar rocketmq-console-ng-1.0.0.jar</code></p>
<h4 id="6、访问"><a href="#6、访问" class="headerlink" title="6、访问"></a>6、访问</h4><p><img src="https://pic.imgdb.cn/item/617ad13d2ab3f51d9158cf11.jpg">{width=”6.106944444444444in” height=”5.16875in”}</p>
<blockquote>
<p>注意：如果此处访问失败，获取不到Topic信息，则很大可能是由于你连接目标mq服务器所在的Linux服务器开启了防火墙导致的，只需要关闭即可。（不确定是这个问题时，可以采取将该console jar 包也上传到服务器上，然后修改namesrvAddr=local host:9876后再访问即可尝试）</p>
</blockquote>
<h3 id="五、集群搭建理论"><a href="#五、集群搭建理论" class="headerlink" title="五、集群搭建理论"></a>五、集群搭建理论</h3><p><img src="https://pic.imgdb.cn/item/617ad2392ab3f51d9159d87e.jpg">{width=”6.106944444444444in” height=”3.657638888888889in”}</p>
<h4 id="1、数据复制与刷盘策略"><a href="#1、数据复制与刷盘策略" class="headerlink" title="1、数据复制与刷盘策略"></a>1、数据复制与刷盘策略</h4><p><img src="https://pic.imgdb.cn/item/617ad5972ab3f51d915db503.jpg">{width=”5.54375in” height=”4.554166666666666in”}</p>
<h5 id="①、复制策略"><a href="#①、复制策略" class="headerlink" title="①、复制策略"></a>①、复制策略</h5><p>复制策略是Broker的Master与Slave间的数据同步方式。分为同步复制与异步复制：</p>
<ul>
<li>同步复制：消息写入master后，master会等待slave同步数据成功后才向producer返回成功ACK</li>
<li>异步复制：消息写入master后，master立即向producer返回成功ACK，无需等待slave同步数据成功</li>
</ul>
<blockquote>
<p>异步复制策略会降低系统的写入延迟， 变小，提高了系统的吞吐量</p>
</blockquote>
<h5 id="②、刷盘策略"><a href="#②、刷盘策略" class="headerlink" title="②、刷盘策略"></a>②、刷盘策略</h5><p>刷盘策略指的是broker中消息的落盘方式，即消息发送到broker内存后消息持久化到磁盘的方式。分为同步刷盘与异步刷盘：</p>
<ul>
<li>同步刷盘：当消息持久化到broker的磁盘后才算是消息写入成功。</li>
<li>异步刷盘：当消息写入到broker的内存后即表示消息写入成功，无需等待消息持久化到磁盘。</li>
</ul>
<blockquote>
<p>1）异步刷盘策略会降低系统的写入延迟，RT变小，提高了系统的吞吐量<br>2）消息写入到Broker的内存，一般是写入到了PageCache<br>3）对于异步 刷盘策略，消息会写入到PageCache后立即返回成功ACK。但并不会立即做落盘操作，而是当PageCache到达一定量时会自动进行落盘。</p>
</blockquote>
<h4 id="2、Broker集群模式"><a href="#2、Broker集群模式" class="headerlink" title="2、Broker集群模式"></a>2、Broker集群模式</h4><p>根据Broker集群中各个节点间关系的不同，Broker集群可以分为以下几类：</p>
<h5 id="①、单Master"><a href="#①、单Master" class="headerlink" title="①、单Master"></a>①、单Master</h5><p>只有一个broker（其本质上就不能称为集群）。这种方式也只能是在测试时使用，生产环境下不能使用，因为存在单点问题。</p>
<h5 id="②、多Master"><a href="#②、多Master" class="headerlink" title="②、多Master"></a>②、多Master</h5><p>broker集群仅由多个master构成，不存在Slave。同一Topic的各个Queue会平均分布在各个master节点上。</p>
<ul>
<li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</li>
<li>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅（不可消费），消息实时性会受到影响。</li>
</ul>
<blockquote>
<p>以上优点的前提是，这些Master都配置了RAID磁盘阵列。如果没有配置，一旦出现某Master宕机，则会发生大量消息丢失的情况。</p>
</blockquote>
<h5 id="③、多Master多Slave模式-异步复制"><a href="#③、多Master多Slave模式-异步复制" class="headerlink" title="③、多Master多Slave模式-异步复制"></a>③、多Master多Slave模式-异步复制</h5><p>broker集群由多个master构成，每个master又配置了多个slave（在配置了RAID磁盘阵列的情况下，一个master一般配置一个slave即可）。master与slave的关系是主备关系，即master负责处理消息的读写请求，而slave仅负责消息的备份与master宕机后的角色切换。</p>
<p>异步复制即前面所讲的<font color="#00FFFF">复制策略</font>中的<font color="#00CED1">异步复制策略</font>，即消息写入master成功后，master立即向producer返回成功ACK，无需等待slave同步数据成功。</p>
<p>该模式的最大特点之一是，当master宕机后slave能够<font color="#00FFFF">自动切换</font>为master。不过由于slave从master的同步具有短暂的延迟（毫秒级），所以当master宕机后，这种异步复制方式可能会存在少量消息的丢失问题。</p>
<blockquote>
<p>Slave从Master同步的延迟越短，其可能丢失的消息就越少<br>对于Master的RAID磁盘阵列，若使用的也是异步复制策略，同样也存在延迟问题，同样也可能会丢失消息。但RAID阵列的秘诀是微秒级的（因为是由硬盘支持的），所以其丢失的数据量会更少。</p>
</blockquote>
<h5 id="④、多Master多Slave模式-同步双写"><a href="#④、多Master多Slave模式-同步双写" class="headerlink" title="④、多Master多Slave模式-同步双写"></a>④、多Master多Slave模式-同步双写</h5><p>该模式是多<font color="#00FFFF">Master多Slave模式</font>的<font color="#FF0000">同步复制</font>实现。所谓<font color="#00FFFF">同步双写</font>，指的是消息写入master成功后，master会等待slave同步数据成功后才向producer返回成功ACK，即master与slave都要写入成功后才会返回成功ACK，也即<font color="#FF0000">双写</font>。</p>
<p>该模式与<font color="#00FFFF">异步复制模式</font>相比，优点是消息的安全性更高，不存在消息丢失的情况。但单个消息的RT略高，从而导致性能要略低（大约低10%）。</p>
<blockquote>
<p>该模式存在一个大的问题：对于目前的版本，Master宕机后，Slave 不会自动切换到Master。</p>
</blockquote>
<h5 id="⑤、最佳实践"><a href="#⑤、最佳实践" class="headerlink" title="⑤、最佳实践"></a>⑤、最佳实践</h5><p>一般会为Master配置RAID10磁盘阵列，然后再为其配置一个Slave。即利用了RAID10磁盘阵列的高效、安全性，又解决了可能会影响订阅的问题。</p>
<blockquote>
<p>1）RAID磁盘阵列的效率要高于Master-Slave集群。因为RAID是硬件支持的。也正因为如此，所以RAID阵列的搭建成本较高。<br>2）多Master+RAID阵列，与多Master多Slave集群的区别是什么？</p>
<blockquote>
<ul>
<li>多Master+RAID阵列，其仅仅可以保证数据不丢失，即不影响消息写入，但其可能会影响到消息的订阅。但其执行效率要远高于<font color="#00FFFF">多Master多Slave集群</font></li>
<li>多Master多Slave集群，其不仅可以保证数据不丢失，也不会影响消息写入。其运行效率要低于<font color="#00FFFF">多Master+RAID阵列</font></li>
</ul>
</blockquote>
</blockquote>
<h3 id="六、磁盘阵列RAID（补充）"><a href="#六、磁盘阵列RAID（补充）" class="headerlink" title="六、磁盘阵列RAID（补充）"></a>六、磁盘阵列RAID（补充）</h3><h4 id="1、RAID历史"><a href="#1、RAID历史" class="headerlink" title="1、RAID历史"></a>1、RAID历史</h4><p>1988 年美国加州大学伯克利分校的 D. A. Patterson 教授等首次在论文 “A Case of Redundant Array of Inexpensive Disks” 中提出了 RAID 概念 ，即<font color="#00FFFF">廉价冗余磁盘阵列</font>（ Redundant Array of Inexpensive Disks ）。由于当时大容量磁盘比较昂贵， RAID 的基本思想是将多个容量较小、相对廉价的磁盘进行有机组合，从而以较低的成本获得与昂贵大容量磁盘相当的容量、性能、可靠性。随着磁盘成本和价格的不断降低， “廉价” 已经毫无意义。因此， RAID 咨询委员会（ RAID Advisory Board, RAB ）决定用” 独立 “ 替代 “ 廉价 “ ，于时 RAID 变成了<font color="#00FFFF">独立磁盘冗余阵列</font>（ Redundant Array of Independent Disks ）。但这仅仅是名称的变化，实质内容没有改变。</p>
<blockquote>
<p>内存：32m 6.4G （IBM 10.1G）</p>
</blockquote>
<h4 id="2、RAID等级"><a href="#2、RAID等级" class="headerlink" title="2、RAID等级"></a>2、RAID等级</h4><p>RAID 这种设计思想很快被业界接纳， RAID 技术作为高性能、高可靠的存储技术，得到了非常广泛的应用。 RAID 主要利用镜像、数据条带和数据校验三种技术来获取高性能、可靠性、容错能力和扩展性，根据对这三种技术的使用策略和组合架构，可以把 RAID 分为不同的等级，以满足不同数据应用的需求。</p>
<p>D.A.Patterson 等的论文中定义了 RAID0 ~ RAID6 原始 RAID 等级。随后存储厂商又不断推出 RAID7、RAID10、RAID01 、 RAID50 、 RAID53 、 RAID100 等 RAID 等级，但这些并无统一的标准。目前业界与学术界公认的标准是 RAID0 ~ RAID6 ，而在实际应用领域中使用最多的 RAID 等级是 RAID0 、 RAID1 、 RAID3 、 RAID5 、 RAID6 和 RAID10。</p>
<p>RAID 每一个等级代表一种实现方法和技术，等级之间并无高低之分。在实际应用中，应当根据用户的数据应用特点，综合考虑可用性、性能和成本来选择合适的 RAID 等级，以及具体的实现方式。</p>
<h4 id="3关键技术"><a href="#3关键技术" class="headerlink" title="3关键技术"></a>3关键技术</h4><h5 id="①、镜像技术"><a href="#①、镜像技术" class="headerlink" title="①、镜像技术"></a>①、镜像技术</h5><p>镜像技术是一种冗余技术，为磁盘提供数据备份功能，防止磁盘发生故障而造成数据丢失。对于 RAID 而言，采用镜像技术最典型地的用法就是，同时在磁盘阵列中产生两个完全相同的数据副本，并且分布在两个不同的磁盘上。镜像提供了完全的数据冗余能力，当一个数据副本失效不可用时，外部系统仍可正常访问另一副本，不会对应用系统运行和性能产生影响。而且，镜像不需要额外的计算和校验，故障修复非常快，直接复制即可。镜像技术可以从多个副本进行并发读取数据，提供更高的读 I/O 性能，但不能并行写数据，写多个副本通常会导致一定的 I/O 性能下降。</p>
<p>镜像技术提供了非常高的数据安全性，其代价也是非常昂贵的，需要至少双倍的存储空间。高成本限制了镜像的广泛应用，主要应用于至关重要的数据保护，这种场合下的数据丢失可能会造成非常巨大的损失。</p>
<h5 id="②、数据条带技术"><a href="#②、数据条带技术" class="headerlink" title="②、数据条带技术"></a>②、数据条带技术</h5><p>数据条带化技术是一种自动将 I/O操作负载均衡到多个物理磁盘上的技术。更具体地说就是，将一块连续的数据分成很多小部分并把它们分别存储到不同磁盘上。这就能使多个进程可以并发访问数据的多个不同部分，从而获得最大程度上的 I/O 并行能力，极大地提升性能。</p>
<h5 id="③、数据校验技术"><a href="#③、数据校验技术" class="headerlink" title="③、数据校验技术"></a>③、数据校验技术</h5><p>数据校验技术是指， RAID 要在写入数据的同时进行校验计算，并将得到的校验数据存储在 RAID 成员磁盘中。校验数据可以集中保存在某个磁盘或分散存储在多个不同磁盘中。当其中一部分数据出错时，就可以对剩余数据和校验数据进行反校验计算重建丢失的数据。</p>
<p>数据校验技术相对于镜像技术的优势在于节省大量开销，但由于每次数据读写都要进行大量的校验运算，对计算机的运算速度要求很高，且必须使用硬件 RAID 控制器。在数据重建恢复方面，检验技术比镜像技术复杂得多且慢得多。</p>
<h4 id="4、RAID分类"><a href="#4、RAID分类" class="headerlink" title="4、RAID分类"></a>4、RAID分类</h4><p>从实现角度看， RAID 主要分为软 RAID、硬 RAID 以及混合 RAID 三种。</p>
<h5 id="①、软-RAID"><a href="#①、软-RAID" class="headerlink" title="①、软 RAID"></a>①、软 RAID</h5><p>所有功能均有操作系统和 CPU 来完成，没有独立的 RAID 控制处理芯片和 I/O 处理芯片，效率自然最低。</p>
<h5 id="②、硬-RAID"><a href="#②、硬-RAID" class="headerlink" title="②、硬 RAID"></a>②、硬 RAID</h5><p>配备了专门的 RAID 控制处理芯片和 I/O 处理芯片以及阵列缓冲，不占用 CPU 资源。效率很高，但成本也很高。</p>
<h5 id="③、混合-RAID"><a href="#③、混合-RAID" class="headerlink" title="③、混合 RAID"></a>③、混合 RAID</h5><p>具备 RAID 控制处理芯片，但没有专门的I/O 处理芯片，需要 CPU 和驱动程序来完成。性能和成本在软 RAID 和硬 RAID 之间。</p>
<h4 id="5、常见RAID等级详解"><a href="#5、常见RAID等级详解" class="headerlink" title="5、常见RAID等级详解"></a>5、常见RAID等级详解</h4><h5 id="①、JBOD"><a href="#①、JBOD" class="headerlink" title="①、JBOD"></a>①、JBOD</h5><p><img src="https://pic.imgdb.cn/item/617ada1f2ab3f51d9162301e.jpg">{width=”2.6055555555555556in” height=”2.3652777777777776in”}</p>
<p>JBOD ，Just a Bunch of Disks，磁盘簇。表示一个没有控制软件提供协调控制的磁盘集合，这是 RAID 区别与 JBOD 的主要因素。 JBOD 将多个物理磁盘串联起来，提供一个巨大的逻辑磁盘。</p>
<p>JBOD 的数据存放机制是由第一块磁盘开始按顺序往后存储，当前磁盘存储空间用完后，再依次往后面的磁盘存储数据。 JBOD 存储性能完全等同于单块磁盘，而且也不提供数据安全保护。</p>
<blockquote>
<p>其只是简单提供一种扩展存储空间的机制， 可用存储容量等于所有成员磁盘的存储空间之和</p>
</blockquote>
<p>JBOD 常指磁盘柜，而不论其是否提供 RAID 功能。不过，JBOD并非官方术语，官方称为Spanning。</p>
<h5 id="②、RAID0"><a href="#②、RAID0" class="headerlink" title="②、RAID0"></a>②、RAID0</h5><p><img src="https://pic.imgdb.cn/item/617ada8a2ab3f51d91628bc8.jpg">{width=”1.5631944444444446in” height=”2.4069444444444446in”}</p>
<p>RAID0 是一种简单的、无数据校验的<font color="#00CED1">数据条带化技术</font>。实际上不是一种真正的 RAID ，因为它并不供任何形式的冗余策略。 RAID0 将所在磁盘条带化后组成大容量的存储空间，将数据分散存储在所有磁盘中，以独立访问方式实现多块磁盘的并读访问。</p>
<p>理论上讲，一个由 n 块磁盘组成的 RAID0 ，它的读写性能是单个磁盘性能的 n 倍，但由于总线带宽等多种因素的限制，实际的性能提升低于理论值。由于可以并发执行 I/O 操作，总线带宽得到充分利用。再加上不需要进行数据校验，<font color="#00CED1">RAID0 的性能在所有 RAID 等级中是最高的</font>。</p>
<p>RAID0 具有低成本、高读写性能、 100% 的高存储空间利用率等优点，但是它不提供数据冗余保护，一旦数据损坏，将无法恢复。</p>
<p>应用场景：对数据的顺序读写要求不高，对数据的安全性和可靠性要求不高，但对系统性能要求很高的场景。</p>
<blockquote>
<p>RAID0与JBOD相同点：<br>1）存储容量：都是成员磁盘容量总和<br>2）磁盘利用率，都是100%，即都没有做任何的数据冗余备份<br>RAID0与JBOD不同点：<br>JBOD：数据是顺序存放的，一个磁盘存满后才会开始存放到下一个磁盘<br>RAID：各个磁盘中的数据写入是并行的，是通过数据条带技术写入的。其读写性能是JBOD的n倍</p>
</blockquote>
<h5 id="③、RAID1"><a href="#③、RAID1" class="headerlink" title="③、RAID1"></a>③、RAID1</h5><p><img src="https://pic.imgdb.cn/item/617adbe12ab3f51d9163d7f4.jpg">{width=”1.5631944444444446in” height=”2.4069444444444446in”}</p>
<p>RAID1 就是一种<font color="#00CED1">镜像技术</font>，它将数据完全一致地分别写到工作磁盘和镜像磁盘，它的磁盘空间利用率为 50% 。 RAID1 在数据写入时，响应时间会有所影响，但是读数据的时候没有影响。 RAID1 提供了最佳的数据保护，一旦工作磁盘发生故障，系统将自动切换到镜像磁盘，不会影响使用。</p>
<p>RAID1是为了增强数据安全性使两块磁盘数据呈现完全镜像，从而达到安全性好、技术简单、管理方便。 RAID1 拥有完全容错的能力，但实现成本高。</p>
<p>应用场景：对顺序读写性能要求较高，或对数据安全性要求较高的场景。</p>
<h5 id="④、RAID10"><a href="#④、RAID10" class="headerlink" title="④、RAID10"></a>④、RAID10</h5><p><img src="https://pic.imgdb.cn/item/617adc622ab3f51d91644fe0.jpg">{width=”3.365972222222222in” height=”3.553472222222222in”}</p>
<p>RAID10是一个RAID1与RAID0的组合体，所以它继承了RAID0的快速和RAID1的安全。</p>
<p>简单来说就是，先做<font color="#00CED1">条带</font>，再做<font color="#00CED1">镜像</font>。发即将进来的数据先分散到不同的磁盘，再将磁盘中的数据做镜像。</p>
<h5 id="⑤、RAID01"><a href="#⑤、RAID01" class="headerlink" title="⑤、RAID01"></a>⑤、RAID01</h5><p><img src="https://pic.imgdb.cn/item/617adca22ab3f51d916484c0.jpg">{width=”3.365972222222222in” height=”3.6055555555555556in”}</p>
<p>RAID01是一个RAID0与RAID1的组合体，所以它继承了RAID0的快速和RAID1的安全。</p>
<p>简单来说就是，先做<font color="#00CED1">镜像</font>再做<font color="#00CED1">条带</font>。即将进来的数据先做镜像，再将镜像数据写入到与之前数据不同的磁盘，即再做条带。</p>
<blockquote>
<p>RAID10要比RAID01的容错率再高，所以生产环境下一般是不使用RAID01的。</p>
</blockquote>
<h3 id="七、集群搭建实践"><a href="#七、集群搭建实践" class="headerlink" title="七、集群搭建实践"></a>七、集群搭建实践</h3><h4 id="1、集群架构"><a href="#1、集群架构" class="headerlink" title="1、集群架构"></a>1、集群架构</h4><p>这里要搭建一个双主双从异步复制的Broker集群。为了方便，这里使用了两台主机来完成集群的搭建。</p>
<p>这两台主机的功能与broker角色分配如下表。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>主机名/IP</th>
<th>IP</th>
<th>功能</th>
<th>BROKER角色</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>rocketmqOS1</td>
<td>192.168.59.164</td>
<td>NameServer + Broker</td>
<td>Master1 + Slave2</td>
</tr>
<tr>
<td>2</td>
<td>rocketmqOS2</td>
<td>192.168.59.165</td>
<td>NameServer + Broker</td>
<td>Master2 + Slave1</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="2、克隆生成rocketmqOS1"><a href="#2、克隆生成rocketmqOS1" class="headerlink" title="2、克隆生成rocketmqOS1"></a>2、克隆生成rocketmqOS1</h4><p>克隆rocketmqOS主机，并修改配置。指定主机名为rocketmqOS1。<br><code>vi /etc/hostname</code></p>
<h4 id="3、修改rocketmqOS1配置文件"><a href="#3、修改rocketmqOS1配置文件" class="headerlink" title="3、修改rocketmqOS1配置文件"></a>3、修改rocketmqOS1配置文件</h4><h5 id="①、配置文件位置"><a href="#①、配置文件位置" class="headerlink" title="①、配置文件位置"></a>①、配置文件位置</h5><p>要修改的配置文件在rocketMQ解压目录的conf/2m-2s-async目录中。</p>
<p><img src="https://pic.imgdb.cn/item/617ade602ab3f51d9166549a.jpg">{width=”6.106944444444444in” height=”1.3652777777777778in”}</p>
<h5 id="②、修改broker-a-properties"><a href="#②、修改broker-a-properties" class="headerlink" title="②、修改broker-a.properties"></a>②、修改broker-a.properties</h5><p>将该配置文件内容修改为如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定整个broker集群的名称，或者说是RocketMQ集群的名称</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment"># 指定master-slave集群的名称。一个RocketMQ集群可以包含多个master-slave集群</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="comment"># master的brokerId为0</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 指定删除消息存储过期文件的时间为凌晨4点</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment"># 指定未发生更新的消息存储文件的保留时长为48小时，48小时后过期，将会被删除</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment"># 指定当前broker为异步复制master</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">ASYNC_MASTER</span></span><br><span class="line"><span class="comment"># 指定刷盘策略为异步刷盘</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="comment"># 指定Name Server的地址</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">192.168.59.164:9876;192.168.59.165:9876</span></span><br></pre></td></tr></table></figure>

<h5 id="③、修改broker-b-s-properties"><a href="#③、修改broker-b-s-properties" class="headerlink" title="③、修改broker-b-s.properties"></a>③、修改broker-b-s.properties</h5><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment"># 指定这是另外一个master-slave集群</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-b</span></span><br><span class="line"><span class="comment"># slave的brokerId为非0</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment"># 指定当前broker为slave</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">SLAVE</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">192.168.59.164:9876;192.168.59.165:9876</span></span><br><span class="line"><span class="comment"># 指定Broker对外提供服务的端口，即Broker与producer与consumer通信的端口。默认</span></span><br><span class="line"><span class="attr">10911。由于当前主机同时充当着master1与slave2，而前面的master1使用的是默认端口。这</span></span><br><span class="line"><span class="attr">里需要将这两个端口加以区分，以区分出master1与slave2</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">11911</span></span><br><span class="line"><span class="comment"># 指定消息存储相关的路径。默认路径为~/store目录。由于当前主机同时充当着master1与</span></span><br><span class="line"><span class="attr">slave2，master1使用的是默认路径，这里就需要再指定一个不同路径</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">~/store-s</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">~/store-s/commitlog</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">~/store-s/consumequeue</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">~/store-s/index</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">~/store-s/checkpoint</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">~/store-s/abort</span></span><br></pre></td></tr></table></figure>

<h5 id="④、其它配置"><a href="#④、其它配置" class="headerlink" title="④、其它配置"></a>④、其它配置</h5><p>除了以上配置外，这些配置文件中还可以设置其它属性。</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#指定整个broker集群的名称，或者说是RocketMQ集群的名称</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">rocket-MS</span></span><br><span class="line"><span class="comment">#指定master-slave集群的名称。一个RocketMQ集群可以包含多个master-slave集群</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">nameserver1:9876;nameserver2:9876</span></span><br><span class="line"><span class="comment">#默认为新建Topic所创建的队列数</span></span><br><span class="line"><span class="attr">defaultTopicQueueNums</span>=<span class="string">4</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议生产环境中关闭</span></span><br><span class="line"><span class="attr">autoCreateTopicEnable</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议生产环境中关闭</span></span><br><span class="line"><span class="attr">autoCreateSubscriptionGroup</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#Broker对外提供服务的端口，即Broker与producer与consumer通信的端口</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">10911</span></span><br><span class="line"><span class="comment">#HA高可用监听端口，即Master与Slave间通信的端口，默认值为listenPort+1</span></span><br><span class="line"><span class="attr">haListenPort</span>=<span class="string">10912</span></span><br><span class="line"><span class="comment">#指定删除消息存储过期文件的时间为凌晨4点</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment">#指定未发生更新的消息存储文件的保留时长为48小时，48小时后过期，将会被删除</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="comment">#指定commitLog目录中每个文件的大小，默认1G</span></span><br><span class="line"><span class="attr">mapedFileSizeCommitLog</span>=<span class="string">1073741824</span></span><br><span class="line"><span class="comment">#指定ConsumeQueue的每个Topic的每个Queue文件中可以存放的消息数量，默认30w条</span></span><br><span class="line"><span class="attr">mapedFileSizeConsumeQueue</span>=<span class="string">300000</span></span><br><span class="line"><span class="comment">#在清除过期文件时，如果该文件被其他线程所占用（引用数大于0，比如读取消息），此时会阻止</span></span><br><span class="line"><span class="attr">此次删除任务，同时在第一次试图删除该文件时记录当前时间戳。该属性则表示从第一次拒绝删除</span></span><br><span class="line"><span class="attr">后开始计时，该文件最多可以保留的时长。在此时间内若引用数仍不为0，则删除仍会被拒绝。不过</span></span><br><span class="line"><span class="attr">时间到后，文件将被强制删除</span></span><br><span class="line"><span class="attr">destroyMapedFileIntervalForcibly</span>=<span class="string">120000</span></span><br><span class="line"><span class="comment">#指定commitlog、consumequeue所在磁盘分区的最大使用率，超过该值，则需立即清除过期文</span></span><br><span class="line"><span class="attr">件</span></span><br><span class="line"><span class="attr">diskMaxUsedSpaceRatio</span>=<span class="string">88</span></span><br><span class="line"><span class="comment">#指定store目录的路径，默认在当前用户主目录中</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">/usr/local/rocketmq-all-4.5.0/store</span></span><br><span class="line"><span class="comment">#commitLog目录路径</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">/usr/local/rocketmq-all-4.5.0/store/commitlog</span></span><br><span class="line"><span class="comment">#consumeueue目录路径</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">/usr/local/rocketmq-all-4.5.0/store/consumequeue</span></span><br><span class="line"><span class="comment">#index目录路径</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">/usr/local/rocketmq-all-4.5.0/store/index</span></span><br><span class="line"><span class="comment">#checkpoint文件路径</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">/usr/local/rocketmq-all-4.5.0/store/checkpoint</span></span><br><span class="line"><span class="comment">#abort文件路径</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">/usr/local/rocketmq-all-4.5.0/store/abort</span></span><br><span class="line"><span class="comment">#指定消息的最大大小</span></span><br><span class="line"><span class="attr">maxMessageSize</span>=<span class="string">65536</span></span><br><span class="line"><span class="comment">#Broker的角色</span></span><br><span class="line"><span class="comment"># - ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment"># - SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment"># - SLAVE</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">SYNC_MASTER</span></span><br><span class="line"><span class="comment">#刷盘策略</span></span><br><span class="line"><span class="comment"># - ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment"># - SYNC_FLUSH 同步刷盘</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">SYNC_FLUSH</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="attr">sendMessageThreadPoolNums</span>=<span class="string">128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="attr">pullMessageThreadPoolNums</span>=<span class="string">128</span></span><br><span class="line"><span class="comment">#强制指定本机IP，需要根据每台机器进行修改。官方介绍可为空，系统默认自动识别，但多网卡</span></span><br><span class="line"><span class="attr">时IP地址可能读取错误</span></span><br><span class="line"><span class="attr">brokerIP1</span>=<span class="string">192.168.3.105</span></span><br></pre></td></tr></table></figure>

<h4 id="4、克隆生成rocketmqOS2"><a href="#4、克隆生成rocketmqOS2" class="headerlink" title="4、克隆生成rocketmqOS2"></a>4、克隆生成rocketmqOS2</h4><p>克隆rocketmqOS1主机，并修改配置。指定主机名为rocketmqOS2。</p>
<h4 id="5、修改rocketmqOS2配置文件"><a href="#5、修改rocketmqOS2配置文件" class="headerlink" title="5、修改rocketmqOS2配置文件"></a>5、修改rocketmqOS2配置文件</h4><p>对于rocketmqOS2主机，同样需要修改rocketMQ解压目录的conf目录的子目录2m-2s-async中的两个配置文件。</p>
<h5 id="①、修改broker-b-properties"><a href="#①、修改broker-b-properties" class="headerlink" title="①、修改broker-b.properties"></a>①、修改broker-b.properties</h5><p>将该配置文件内容修改为如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-b</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">ASYNC_MASTER</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">192.168.59.164:9876;192.168.59.165:9876</span></span><br></pre></td></tr></table></figure>

<h5 id="②、修改broker-a-s-properties"><a href="#②、修改broker-a-s-properties" class="headerlink" title="②、修改broker-a-s.properties"></a>②、修改broker-a-s.properties</h5><p>将该配置文件内容修改为如下：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">48</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">SLAVE</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="attr">namesrvAddr</span>=<span class="string">192.168.59.164:9876;192.168.59.165:9876</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">11911</span></span><br><span class="line"><span class="attr">storePathRootDir</span>=<span class="string">~/store-s</span></span><br><span class="line"><span class="attr">storePathCommitLog</span>=<span class="string">~/store-s/commitlog</span></span><br><span class="line"><span class="attr">storePathConsumeQueue</span>=<span class="string">~/store-s/consumequeue</span></span><br><span class="line"><span class="attr">storePathIndex</span>=<span class="string">~/store-s/index</span></span><br><span class="line"><span class="attr">storeCheckpoint</span>=<span class="string">~/store-s/checkpoint</span></span><br><span class="line"><span class="attr">abortFile</span>=<span class="string">~/store-s/abort</span></span><br></pre></td></tr></table></figure>

<h4 id="6、启动服务器"><a href="#6、启动服务器" class="headerlink" title="6、启动服务器"></a>6、启动服务器</h4><h5 id="①、启动NameServer集群"><a href="#①、启动NameServer集群" class="headerlink" title="①、启动NameServer集群"></a>①、启动NameServer集群</h5><p>分别启动rocketmqOS1与rocketmqOS2两个主机中的NameServer。启动命令完全相同。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqnamesrv &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/namesrv.log</span><br></pre></td></tr></table></figure>

<h5 id="②、启动两个Master"><a href="#②、启动两个Master" class="headerlink" title="②、启动两个Master"></a>②、启动两个Master</h5><p>分别启动rocketmqOS1与rocketmqOS2两个主机中的broker master。注意，它们指定所要加载的配置文件是不同的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqbroker -c conf/2m-2s-async/broker-a.properties &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqbroker -c conf/2m-2s-async/broker-b.properties &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<h5 id="③、启动两个Slave"><a href="#③、启动两个Slave" class="headerlink" title="③、启动两个Slave"></a>③、启动两个Slave</h5><p>分别启动rocketmqOS1与rocketmqOS2两个主机中的broker slave。注意，它们指定所要加载的配置文件是不同的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqbroker -c conf/2m-2s-async/broker-b-s.properties &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup sh bin/mqbroker -c conf/2m-2s-async/broker-a-s.properties &amp;</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure>

<h3 id="八、mqadmin命令"><a href="#八、mqadmin命令" class="headerlink" title="八、mqadmin命令"></a>八、mqadmin命令</h3><p>在mq解压目录的bin目录下有一个mqadmin命令，该命令是一个运维指令，用于对mq的主题，集群， broker 等信息进行管理。</p>
<h4 id="1、修改bin-tools-sh"><a href="#1、修改bin-tools-sh" class="headerlink" title="1、修改bin/tools.sh"></a>1、修改bin/tools.sh</h4><p>在运行mqadmin命令之前，先要修改mq解压目录下bin/tools.sh配置的JDK的ext目录位置。本机的ext目录在<font color="#00CED1">/usr/java/jdk1.8.0_161/jre/lib/ext</font> 。</p>
<p>使用vim命令打开tools.sh文件，并在JAVA_OPT配置的-Djava.ext.dirs这一行的后面添加ext的路径。</p>
<p><img src="https://pic.imgdb.cn/item/617ae2d62ab3f51d91696393.jpg">{width=”6.106944444444444in” height=”0.53125in”}</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">JAVA_OPT</span>=<span class="string">&quot;$&#123;JAVA_OPT&#125; -server -Xms1g -Xmx1g -Xmn256m -</span></span><br><span class="line"><span class="attr">XX</span>:<span class="string">MetaspaceSize=128m -XX:MaxMetaspaceSize=128m&quot;</span></span><br><span class="line"><span class="attr">JAVA_OPT</span>=<span class="string">&quot;$&#123;JAVA_OPT&#125; -</span></span><br><span class="line"><span class="meta">Djava.ext.dirs</span>=<span class="string">$&#123;BASE_DIR&#125;/lib:$&#123;JAVA_HOME&#125;/jre/lib/ext:$&#123;JAVA_HOME&#125;/lib/</span></span><br><span class="line"><span class="attr">ext</span>:<span class="string">/usr/java/jdk1.8.0_161/jre/lib/ext&quot;</span></span><br><span class="line"><span class="attr">JAVA_OPT</span>=<span class="string">&quot;$&#123;JAVA_OPT&#125; -cp $&#123;CLASSPATH&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="2、运行mqadmin"><a href="#2、运行mqadmin" class="headerlink" title="2、运行mqadmin"></a>2、运行mqadmin</h4><p>直接运行该命令，可以看到其可以添加的commands。通过这些commands可以完成很多的功能。</p>
<p><img src="https://pic.imgdb.cn/item/617ae36c2ab3f51d9169cdd2.jpg">{width=”8.26388888888889in” height=”5.439583333333333in”}</p>
<h4 id="3、该命令的官网详解"><a href="#3、该命令的官网详解" class="headerlink" title="3、该命令的官网详解"></a>3、该命令的官网详解</h4><p>该命令在官网中有详细的用法解释。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md">https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md</a></p>
<p><img src="https://pic.imgdb.cn/item/617ae3cb2ab3f51d916a0e21.jpg">{width=”6.106944444444444in” height=”1.5631944444444446in”}</p>
<p><img src="https://pic.imgdb.cn/item/617ae3f52ab3f51d916a29a8.jpg">{width=”6.106944444444444in” height=”4.1375in”}</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Lorem Moon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://hello-github-ui.github.io/posts/53514/">https://hello-github-ui.github.io/posts/53514/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/RocketMQ/">RocketMQ</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imgdb.cn/item/617bf6342ab3f51d9143ec11.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/16752/" title="分布式消息队列RocketMQ-学习文档-第一章"><img class="cover" src="https://pic.imgdb.cn/item/617bf5102ab3f51d9142881a.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">分布式消息队列RocketMQ-学习文档-第一章</div></div></a></div><div><a href="/posts/56691/" title="分布式消息队列RocketMQ-学习文档-第三章"><img class="cover" src="https://pic.imgdb.cn/item/617bf7d52ab3f51d914620c9.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">分布式消息队列RocketMQ-学习文档-第三章</div></div></a></div><div><a href="/posts/46002/" title="分布式消息队列RocketMQ-学习文档-第四章"><img class="cover" src="https://pic.imgdb.cn/item/617bf8f32ab3f51d914779e4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-29</div><div class="title">分布式消息队列RocketMQ-学习文档-第四章</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic.imgdb.cn/item/6159d89b2ab3f51d91b0e8d0.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Lorem Moon</div><div class="author-info__description">即已成过往，便随它而去吧。</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">60</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">46</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hello-github-ui" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:util.you.come@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97RocketMQ%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3"><span class="toc-number">1.</span> <span class="toc-text">分布式消息队列RocketMQ学习文档</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC2%E7%AB%A0-RocketMQ%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.</span> <span class="toc-text">第2章 RocketMQ的安装与启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.1.</span> <span class="toc-text">一、基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%B6%88%E6%81%AF%EF%BC%88Message%EF%BC%89"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">1、消息（Message）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E4%B8%BB%E9%A2%98%EF%BC%88Topic%EF%BC%89"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">2、主题（Topic）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%A0%87%E7%AD%BE%EF%BC%88Tag%EF%BC%89"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">3、标签（Tag）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E9%98%9F%E5%88%97%EF%BC%88Queue%EF%BC%89"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">4、队列（Queue）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E6%B6%88%E6%81%AF%E6%A0%87%E8%AF%86%EF%BC%88MessageId-Key%EF%BC%89"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">5、消息标识（MessageId&#x2F;Key）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">二、系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81Producer"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">1、Producer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Consumer"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">2、Consumer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81Name-Server"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">3、Name Server</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.2.3.1.</span> <span class="toc-text">①、功能介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.1.2.3.2.</span> <span class="toc-text">②、路由注册</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E8%B7%AF%E7%94%B1%E5%89%94%E9%99%A4"><span class="toc-number">1.1.2.3.3.</span> <span class="toc-text">③、路由剔除</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A3%E3%80%81%E8%B7%AF%E7%94%B1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.1.2.3.4.</span> <span class="toc-text">④、路由发现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A4%E3%80%81%E5%AE%A2%E6%88%B7%E7%AB%AFNameServer%E9%80%89%E6%8B%A9%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.2.3.5.</span> <span class="toc-text">⑤、客户端NameServer选择策略</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Broker"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">4 Broker</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">1.1.2.4.1.</span> <span class="toc-text">①、功能介绍</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E6%A8%A1%E5%9D%97%E6%9E%84%E6%88%90"><span class="toc-number">1.1.2.4.2.</span> <span class="toc-text">②、模块构成</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="toc-number">1.1.2.4.3.</span> <span class="toc-text">③、集群部署</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">5 工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%85%B7%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.2.5.1.</span> <span class="toc-text">①、具体流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81Topic"><span class="toc-number">1.1.2.5.2.</span> <span class="toc-text">②、Topic</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E8%AF%BB-%E5%86%99%E9%98%9F%E5%88%97"><span class="toc-number">1.1.2.5.3.</span> <span class="toc-text">③、读&#x2F;写队列</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85%E4%B8%8E%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.3.</span> <span class="toc-text">三、单机安装与启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1、准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E8%BD%AF%E7%A1%AC%E4%BB%B6%E9%9C%80%E6%B1%82"><span class="toc-number">1.1.3.1.1.</span> <span class="toc-text">①、软硬件需求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E4%B8%8B%E8%BD%BDRocketMQ%E5%AE%89%E8%A3%85%E5%8C%85"><span class="toc-number">1.1.3.1.2.</span> <span class="toc-text">②、下载RocketMQ安装包</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%86%85%E5%AD%98"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">2、修改初始内存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E4%BF%AE%E6%94%B9runserver-sh"><span class="toc-number">1.1.3.2.1.</span> <span class="toc-text">①、修改runserver.sh</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E4%BF%AE%E6%94%B9runbroker-sh"><span class="toc-number">1.1.3.2.2.</span> <span class="toc-text">②、修改runbroker.sh</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">3、启动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%90%AF%E5%8A%A8NameServer"><span class="toc-number">1.1.3.3.1.</span> <span class="toc-text">①、启动NameServer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E5%90%AF%E5%8A%A8broker"><span class="toc-number">1.1.3.3.2.</span> <span class="toc-text">②、启动broker</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%8F%91%E9%80%81-%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%E6%B5%8B%E8%AF%95"><span class="toc-number">1.1.3.4.</span> <span class="toc-text">4、发送&#x2F;接收消息测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.3.4.1.</span> <span class="toc-text">①、发送消息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.3.4.2.</span> <span class="toc-text">②、接收消息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%85%B3%E9%97%ADServer"><span class="toc-number">1.1.3.5.</span> <span class="toc-text">5、关闭Server</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text">四、 控制台的安装与启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">1、下载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">2、修改配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">3、添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E6%89%93%E5%8C%85"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">4、打包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">5、启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E8%AE%BF%E9%97%AE"><span class="toc-number">1.1.4.6.</span> <span class="toc-text">6、访问</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E7%90%86%E8%AE%BA"><span class="toc-number">1.1.5.</span> <span class="toc-text">五、集群搭建理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6%E4%B8%8E%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">1、数据复制与刷盘策略</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.5.1.1.</span> <span class="toc-text">①、复制策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-number">1.1.5.1.2.</span> <span class="toc-text">②、刷盘策略</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81Broker%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">2、Broker集群模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%8D%95Master"><span class="toc-number">1.1.5.2.1.</span> <span class="toc-text">①、单Master</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E5%A4%9AMaster"><span class="toc-number">1.1.5.2.2.</span> <span class="toc-text">②、多Master</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E5%A4%9AMaster%E5%A4%9ASlave%E6%A8%A1%E5%BC%8F-%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="toc-number">1.1.5.2.3.</span> <span class="toc-text">③、多Master多Slave模式-异步复制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A3%E3%80%81%E5%A4%9AMaster%E5%A4%9ASlave%E6%A8%A1%E5%BC%8F-%E5%90%8C%E6%AD%A5%E5%8F%8C%E5%86%99"><span class="toc-number">1.1.5.2.4.</span> <span class="toc-text">④、多Master多Slave模式-同步双写</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A4%E3%80%81%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.1.5.2.5.</span> <span class="toc-text">⑤、最佳实践</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E7%A3%81%E7%9B%98%E9%98%B5%E5%88%97RAID%EF%BC%88%E8%A1%A5%E5%85%85%EF%BC%89"><span class="toc-number">1.1.6.</span> <span class="toc-text">六、磁盘阵列RAID（补充）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81RAID%E5%8E%86%E5%8F%B2"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">1、RAID历史</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81RAID%E7%AD%89%E7%BA%A7"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">2、RAID等级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF"><span class="toc-number">1.1.6.3.</span> <span class="toc-text">3关键技术</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E9%95%9C%E5%83%8F%E6%8A%80%E6%9C%AF"><span class="toc-number">1.1.6.3.1.</span> <span class="toc-text">①、镜像技术</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E6%95%B0%E6%8D%AE%E6%9D%A1%E5%B8%A6%E6%8A%80%E6%9C%AF"><span class="toc-number">1.1.6.3.2.</span> <span class="toc-text">②、数据条带技术</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C%E6%8A%80%E6%9C%AF"><span class="toc-number">1.1.6.3.3.</span> <span class="toc-text">③、数据校验技术</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81RAID%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.6.4.</span> <span class="toc-text">4、RAID分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E8%BD%AF-RAID"><span class="toc-number">1.1.6.4.1.</span> <span class="toc-text">①、软 RAID</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E7%A1%AC-RAID"><span class="toc-number">1.1.6.4.2.</span> <span class="toc-text">②、硬 RAID</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E6%B7%B7%E5%90%88-RAID"><span class="toc-number">1.1.6.4.3.</span> <span class="toc-text">③、混合 RAID</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E5%B8%B8%E8%A7%81RAID%E7%AD%89%E7%BA%A7%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.1.6.5.</span> <span class="toc-text">5、常见RAID等级详解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81JBOD"><span class="toc-number">1.1.6.5.1.</span> <span class="toc-text">①、JBOD</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81RAID0"><span class="toc-number">1.1.6.5.2.</span> <span class="toc-text">②、RAID0</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81RAID1"><span class="toc-number">1.1.6.5.3.</span> <span class="toc-text">③、RAID1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A3%E3%80%81RAID10"><span class="toc-number">1.1.6.5.4.</span> <span class="toc-text">④、RAID10</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A4%E3%80%81RAID01"><span class="toc-number">1.1.6.5.5.</span> <span class="toc-text">⑤、RAID01</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.1.7.</span> <span class="toc-text">七、集群搭建实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.7.1.</span> <span class="toc-text">1、集群架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E5%85%8B%E9%9A%86%E7%94%9F%E6%88%90rocketmqOS1"><span class="toc-number">1.1.7.2.</span> <span class="toc-text">2、克隆生成rocketmqOS1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9rocketmqOS1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.7.3.</span> <span class="toc-text">3、修改rocketmqOS1配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.1.7.3.1.</span> <span class="toc-text">①、配置文件位置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E4%BF%AE%E6%94%B9broker-a-properties"><span class="toc-number">1.1.7.3.2.</span> <span class="toc-text">②、修改broker-a.properties</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E4%BF%AE%E6%94%B9broker-b-s-properties"><span class="toc-number">1.1.7.3.3.</span> <span class="toc-text">③、修改broker-b-s.properties</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A3%E3%80%81%E5%85%B6%E5%AE%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.7.3.4.</span> <span class="toc-text">④、其它配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81%E5%85%8B%E9%9A%86%E7%94%9F%E6%88%90rocketmqOS2"><span class="toc-number">1.1.7.4.</span> <span class="toc-text">4、克隆生成rocketmqOS2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81%E4%BF%AE%E6%94%B9rocketmqOS2%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.7.5.</span> <span class="toc-text">5、修改rocketmqOS2配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E4%BF%AE%E6%94%B9broker-b-properties"><span class="toc-number">1.1.7.5.1.</span> <span class="toc-text">①、修改broker-b.properties</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E4%BF%AE%E6%94%B9broker-a-s-properties"><span class="toc-number">1.1.7.5.2.</span> <span class="toc-text">②、修改broker-a-s.properties</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.1.7.6.</span> <span class="toc-text">6、启动服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A0%E3%80%81%E5%90%AF%E5%8A%A8NameServer%E9%9B%86%E7%BE%A4"><span class="toc-number">1.1.7.6.1.</span> <span class="toc-text">①、启动NameServer集群</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A1%E3%80%81%E5%90%AF%E5%8A%A8%E4%B8%A4%E4%B8%AAMaster"><span class="toc-number">1.1.7.6.2.</span> <span class="toc-text">②、启动两个Master</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E2%91%A2%E3%80%81%E5%90%AF%E5%8A%A8%E4%B8%A4%E4%B8%AASlave"><span class="toc-number">1.1.7.6.3.</span> <span class="toc-text">③、启动两个Slave</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E3%80%81mqadmin%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.8.</span> <span class="toc-text">八、mqadmin命令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81%E4%BF%AE%E6%94%B9bin-tools-sh"><span class="toc-number">1.1.8.1.</span> <span class="toc-text">1、修改bin&#x2F;tools.sh</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81%E8%BF%90%E8%A1%8Cmqadmin"><span class="toc-number">1.1.8.2.</span> <span class="toc-text">2、运行mqadmin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81%E8%AF%A5%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%98%E7%BD%91%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.1.8.3.</span> <span class="toc-text">3、该命令的官网详解</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4723/" title="Redis主从搭建"><img src="https://pic.imgdb.cn/item/61210fda4907e2d39c439d0c.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis主从搭建"/></a><div class="content"><a class="title" href="/posts/4723/" title="Redis主从搭建">Redis主从搭建</a><time datetime="2022-10-22T06:47:40.080Z" title="Created 2022-10-22 14:47:40">2022-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/43818/" title="Win10开启上帝模式"><img src="https://pic.imgdb.cn/item/621ddc1c2ab3f51d914c66cb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Win10开启上帝模式"/></a><div class="content"><a class="title" href="/posts/43818/" title="Win10开启上帝模式">Win10开启上帝模式</a><time datetime="2022-03-08T12:24:42.000Z" title="Created 2022-03-08 20:24:42">2022-03-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/55966/" title="Ubuntu修改静态IP"><img src="https://pic.imgdb.cn/item/621ddc1c2ab3f51d914c66cb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ubuntu修改静态IP"/></a><div class="content"><a class="title" href="/posts/55966/" title="Ubuntu修改静态IP">Ubuntu修改静态IP</a><time datetime="2022-03-04T16:11:25.000Z" title="Created 2022-03-05 00:11:25">2022-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/42154/" title="Java封装同步锁"><img src="https://pic.imgdb.cn/item/621ddc1c2ab3f51d914c66cb.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java封装同步锁"/></a><div class="content"><a class="title" href="/posts/42154/" title="Java封装同步锁">Java封装同步锁</a><time datetime="2022-03-02T12:50:01.000Z" title="Created 2022-03-02 20:50:01">2022-03-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/1553/" title="初识大数据(一)"><img src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="初识大数据(一)"/></a><div class="content"><a class="title" href="/posts/1553/" title="初识大数据(一)">初识大数据(一)</a><time datetime="2022-03-01T07:53:43.000Z" title="Created 2022-03-01 15:53:43">2022-03-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://pic.imgdb.cn/item/617bf6342ab3f51d9143ec11.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2017 - 2022 By Lorem Moon</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://hello-blogger-ui.blogspot.com/">google blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Algolia</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'mFM6i90bN6KqyTH6tmC3q7dz-gzGzoHsz',
      appKey: 'T2tsKoiKjMaB0wgtIAgSz6Ul',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>